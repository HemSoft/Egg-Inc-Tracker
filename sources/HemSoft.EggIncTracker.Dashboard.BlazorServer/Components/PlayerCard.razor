@namespace HemSoft.EggIncTracker.Dashboard.BlazorServer.Components

@if (Player != null && PlayerStats != null)
{
    <MudPaper Class="@($"dashboard-tile d-flex flex-column align-center {(_allGoalsAchieved ? "goals-achieved" : "")}")"
             Style="@($"height: 100%; position: relative; overflow: hidden; {(_allGoalsAchieved ? "background-color: rgba(0, 100, 0, 0.3);" : "")}")">

        <div class="mb-4 text-center">
            <MudText Typo="Typo.h4" Align="Align.Center">@Player.PlayerName</MudText>
            <MudText Typo="Typo.body1" Align="Align.Center">
                <MudText Inline="true" Class="ml-2 align-bottom">
                    (@Player?.Title
                    @if (LastUpdatedTimestamp.HasValue && LastUpdatedTimestamp.Value != DateTime.MinValue)
                    {
                        <span> -- Last Updated: @GetLocalTimeString(LastUpdatedTimestamp)</span>
                    })
                </MudText>
            </MudText>
            <MudText Typo="Typo.body1" Align="Align.Center">
                <span class="d-inline-flex align-center mr-2">
                    <MudImage src="/assets/egg_of_prophecy.webp" Width="24" Height="24" Style="vertical-align: middle;">
                    </MudImage>
                    @Player?.ProphecyEggs
                </span>
                <span class="d-inline-flex align-center mr-2">
                    <MudImage src="/assets/egg_soul.webp" Width="24" Height="24" Style="vertical-align: middle;"></MudImage>
                    @Player?.SoulEggs
                </span>
                <span class="d-inline-flex align-center mr-2">
                    <MudImage src="/assets/chart.png" Width="24" Height="24" Style="vertical-align: middle;">
                    </MudImage>
                    @Player?.EarningsBonusPercentage
                </span>
            </MudText>
            <MudText Typo="Typo.subtitle2" Align="Align.Center" Class="mb-2">
                <span class="d-inline-flex align-center mr-2">
                    SE/Week: (@PlayerStats?.SEPerWeek)
                </span>
                <span class="d-inline-flex align-center mr-2">
                    @* Use null-conditional access for PlayerGoals properties *@
                    @if ((_localPlayerSEThisWeek.HasValue) &&
                         ((PlayerGoals?.WeeklySEGainGoal != null && !string.IsNullOrEmpty(PlayerGoals.WeeklySEGainGoal)) ||
                          (PlayerGoals?.EggDayGoal != null && !string.IsNullOrEmpty(PlayerGoals.EggDayGoal))))
                    {
                        string formattedSEThisWeek = FormatBigIntegerDisplay(_localPlayerSEThisWeek);
                        var (isGoalMet, missingAmount, expectedAmount, percentComplete,
                             eggDayGoalStr, currentSEStr, seLeftStr, weeksRemaining, weeklySEGoalStr) =
                            PlayerDataService.CalculateMissingSEGain(_localPlayerSEThisWeek, PlayerGoals?.WeeklySEGainGoal, PlayerGoals?.EggDayGoal);

                        string goalType = !string.IsNullOrEmpty(PlayerGoals?.EggDayGoal) ? "Egg Day" : "Weekly";

                        // Calculate days until Egg Day for display
                        var today = DateTime.Today;
                        var currentYear = today.Year;
                        var eggDay = new DateTime(currentYear, 7, 14);
                        if (today > eggDay)
                        {
                            eggDay = new DateTime(currentYear + 1, 7, 14);
                        }
                        var daysUntilEggDay = (eggDay - today).Days;

                        // Generate clean HTML for the tooltip content
                        string tooltipHtml = @"<div class=""se-tooltip"">
                            <div class=""se-tooltip-section"">
                                <div class=""se-tooltip-header"">";

                        if (isGoalMet)
                        {
                            tooltipHtml += @"<strong>Goal met!</strong>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Current progress:</div>
                                    <div class=""se-tooltip-value"">" + formattedSEThisWeek + @" (" + percentComplete + @"%)</div>
                                </div>";
                        }
                        else
                        {
                            tooltipHtml += @"<strong>Progress toward goal</strong>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Missing:</div>
                                    <div class=""se-tooltip-value"">" + missingAmount + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Egg Day Goal:</div>
                                    <div class=""se-tooltip-value"">" + expectedAmount + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Percent complete:</div>
                                    <div class=""se-tooltip-value"">" + percentComplete + @"%</div>
                                </div>";
                        }

                        // Add the Egg Day section if available
                        if (!string.IsNullOrEmpty(eggDayGoalStr) && !string.IsNullOrEmpty(currentSEStr) &&
                            !string.IsNullOrEmpty(seLeftStr) && weeksRemaining.HasValue && !string.IsNullOrEmpty(weeklySEGoalStr))
                        {
                            tooltipHtml += @"</div>
                            <div class=""se-tooltip-section"">
                                <div class=""se-tooltip-header""><strong>Egg Day Goal Breakdown</strong></div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Egg Day Goal:</div>
                                    <div class=""se-tooltip-value"">" + eggDayGoalStr + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Current SE:</div>
                                    <div class=""se-tooltip-value"">" + currentSEStr + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">SE Left:</div>
                                    <div class=""se-tooltip-value"">" + seLeftStr + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Days until Egg Day:</div>
                                    <div class=""se-tooltip-value"">" + daysUntilEggDay + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Weeks until Egg Day:</div>
                                    <div class=""se-tooltip-value"">" + weeksRemaining.Value.ToString("F2") + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Weekly SE Goal:</div>
                                    <div class=""se-tooltip-value"">" + weeklySEGoalStr + @"</div>
                                </div>";

                            // Add Prestige estimates
                            tooltipHtml += @"</div>
                            <div class=""se-tooltip-section"">
                                <div class=""se-tooltip-header""><strong>Prestige Estimates</strong></div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Est. prestiges left (total):</div>
                                    <div class=""se-tooltip-value"">" + CalculateEstimatedPrestigesLeftTotal(seLeftStr, Player?.PrestigesThisWeek, _localPlayerSEThisWeek) + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Est. prestiges left/week:</div>
                                    <div class=""se-tooltip-value"">" + CalculateEstimatedPrestigesLeftPerWeek(seLeftStr, Player?.PrestigesThisWeek, _localPlayerSEThisWeek, weeksRemaining) + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Est. prestiges left/day:</div>
                                    <div class=""se-tooltip-value"">" + CalculateEstimatedPrestigesLeftPerDay(seLeftStr, Player?.PrestigesThisWeek, _localPlayerSEThisWeek, daysUntilEggDay) + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">Est. prestiges left/today:</div>
                                    <div class=""se-tooltip-value"">" + CalculateEstimatedPrestigesLeftForTodayConsistent(missingAmount, Player?.PrestigesThisWeek, _localPlayerSEThisWeek, (int)DateTime.Now.DayOfWeek == 0 ? 7 : (int)DateTime.Now.DayOfWeek) + @"</div>
                                </div>
                                <div class=""se-tooltip-row"">
                                    <div class=""se-tooltip-label"">SE Gain/Prestige:</div>
                                    <div class=""se-tooltip-value"">" + CalculateSEGainPerPrestige(Player?.PrestigesThisWeek, _localPlayerSEThisWeek) + @"</div>
                                </div>
                            </div>";
                        }

                        tooltipHtml += "</div>"; // Close the main tooltip div

                        <MudTooltip Arrow="true" Placement="Placement.Top" Color="Color.Dark" TransformOrigin="Origin.BottomCenter" Class="mud-tooltip-custom">
                            <ChildContent>
                                <span>
                                    SE This Week: <span style="@PlayerDataService.GetSEProgressColorStyle(_localPlayerSEThisWeek, PlayerGoals?.WeeklySEGainGoal, PlayerGoals?.EggDayGoal)">@formattedSEThisWeek</span>
                                    @if (isGoalMet)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.Check" Size="Size.Small" Color="Color.Success" Class="ml-1"></MudIcon>
                                    }
                                </span>
                            </ChildContent>
                            <TooltipContent>
                                <div>@((MarkupString)tooltipHtml)</div>
                            </TooltipContent>
                        </MudTooltip>
                    }
                    else
                    {
                        <span>SE This Week: @(_localPlayerSEThisWeek.HasValue ? FormatBigIntegerDisplay(_localPlayerSEThisWeek) : "N/A")</span>
                    }
                </span>
                <span class="d-inline-flex align-center mr-2">
                    Prestiges Today/Week/Total:
                     @* Use null-conditional access for PlayerGoals properties *@
                    @if (PlayerGoals?.DailyPrestigeGoal > 0)
                    {
                        var (isDailyGoalMet, missingDailyPrestiges, expectedDailyPrestiges, dailyPercentComplete) = PlayerDataService.CalculateMissingDailyPrestiges(Player?.PrestigesToday, PlayerGoals.DailyPrestigeGoal);
                        string dailyTooltipText = isDailyGoalMet
                            ? $"Goal met! Current progress: {Player?.PrestigesToday} / Expected: {expectedDailyPrestiges} ({dailyPercentComplete}%)"
                            : $"Missing {missingDailyPrestiges} prestiges to reach today's goal of {expectedDailyPrestiges} ({dailyPercentComplete}%)";
                        <MudTooltip Text="@dailyTooltipText" Arrow="true" Placement="Placement.Top">
                            <span>
                                <span style="@GetProgressColorStyle(Player?.PrestigesToday, PlayerGoals.DailyPrestigeGoal)">
                                    @Player?.PrestigesToday
                                </span>
                                @if (isDailyGoalMet)
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.Check" Size="Size.Small"
                                        Color="Color.Success" Class="ml-1"></MudIcon>
                                }
                            </span>
                        </MudTooltip>
                        <span> / </span>
                         @* Use null-conditional access for PlayerGoals properties *@
                        var (isWeeklyGoalMet, missingWeeklyPrestiges, expectedWeeklyPrestiges, weeklyPercentComplete) = PlayerDataService.CalculateMissingPrestiges(Player?.PrestigesThisWeek, PlayerGoals?.DailyPrestigeGoal ?? 0);
                        string weeklyTooltipText = isWeeklyGoalMet
                            ? $"Goal met! Current progress: {Player?.PrestigesThisWeek} / Expected: {expectedWeeklyPrestiges} ({weeklyPercentComplete}%)"
                            : $"Missing {missingWeeklyPrestiges} prestiges to reach today's goal of {expectedWeeklyPrestiges} ({weeklyPercentComplete}%)";
                        <MudTooltip Text="@weeklyTooltipText" Arrow="true" Placement="Placement.Top">
                            <span>
                                <span style="@GetProgressColorStyle(Player?.PrestigesThisWeek, expectedWeeklyPrestiges)">
                                    @Player?.PrestigesThisWeek
                                </span>
                                @if (isWeeklyGoalMet)
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.Check" Size="Size.Small"
                                        Color="Color.Success" Class="ml-1"></MudIcon>
                                }
                            </span>
                        </MudTooltip>
                        <span> / </span>
                         @* Use null-conditional access for PlayerGoals properties *@
                        string totalTooltipText = "";
                        bool isTotalGoalMet = false;
                        int expectedTotalPrestiges = Player?.Prestiges ?? 0;
                        <MudTooltip Text="@totalTooltipText" Arrow="true" Placement="Placement.Top">
                            <span>
                                <span style="@GetProgressColorStyle(Player?.Prestiges, expectedTotalPrestiges)">
                                    @Player?.Prestiges
                                </span>
                                @if (isTotalGoalMet)
                                {
                                    <MudIcon Icon="@Icons.Material.Outlined.Check" Size="Size.Small"
                                        Color="Color.Success" Class="ml-1"></MudIcon>
                                }
                            </span>
                        </MudTooltip>
                    }
                    else
                    {
                        <span>@Player?.PrestigesToday / @Player?.PrestigesThisWeek</span>
                    }
                </span>
            </MudText>
        </div>
        <div class="mb-2 d-flex flex-column align-center">
            <div class="donut-chart-container" style="position: relative; width: 300px; height: 300px;">
                <div class="donut-chart-progress"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: white;">@Player?.TitleProgress.ToString("F2")%
                    </div>
                    <div style="font-size: 14px; color: #ccc;">Next title in @DaysToNextTitle days</div>
                </div>
                <svg width="300" height="300" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="transparent" stroke="#666666" stroke-width="10" />
                    <circle cx="50" cy="50" r="45" fill="transparent" stroke="#4CAF50" stroke-width="10"
                        stroke-dasharray="@(2.83 * Player?.TitleProgress ?? 0) 283" stroke-dashoffset="0"
                        transform="rotate(-90 50 50)" />
                </svg>
            </div>
        </div>
        <!---------------------->
        <!-- SE Progress Bar: -->
        <!---------------------->
        <div class="mt-n2 px-4" style="width: 100%;">
            <MudText Typo="Typo.subtitle2" Class="mb-0">
                SE (@PlayerStats?.SE) -- Rank: @((SEGoalEnd?.Ranking ?? 0) + 1)
            </MudText>
            <MudProgressLinear Color="Color.Success" Value="@PlayerSEGoalPercentage" Max="100" Striped="false"
                Size="Size.Large" Style="height: 20px; border-radius: 4px;" Class="my-0">
                <MudText Typo="Typo.caption" Style="color: white;">
                    @PlayerSEGoalPercentage.ToString("F1")%
                </MudText>
            </MudProgressLinear>
            <div class="d-flex justify-space-between mt-n1">
                <MudTooltip Text="@GetNextPlayersTooltip(NextLowerSEPlayers, "SE")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        (@SEGoalBegin?.SEString) @(SEGoalBegin?.IGN?.Length > NameCutOff ?
                                        SEGoalBegin.IGN.Substring(0, NameCutOff) : SEGoalBegin?.IGN)
                    </MudText>
                </MudTooltip>
                <MudTooltip Text="@GetNextPlayersTooltip(NextUpperSEPlayers, "SE")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        @(SEGoalEnd?.IGN?.Length > NameCutOff ? SEGoalEnd.IGN.Substring(0, NameCutOff) :
                                        SEGoalEnd?.IGN) (@SEGoalEnd?.SEString)
                    </MudText>
                </MudTooltip>
            </div>
        </div>
        <!---------------------->
        <!-- EB Progress Bar: -->
        <!---------------------->
        <div class="mt-2 px-4" style="width: 100%;">
            <MudText Typo="Typo.subtitle2" Class="mb-0">
                EB (@PlayerStats?.EB) -- Rank: @(EBGoalEnd?.Ranking + 1)
            </MudText>
            <MudProgressLinear Color="Color.Success" Value="@PlayerEBGoalPercentage" Max="100" Striped="false"
                Size="Size.Large" Style="height: 20px; border-radius: 4px;" Class="my-0">
                <MudText Typo="Typo.caption" Style="color: white;">
                    @PlayerEBGoalPercentage.ToString("F1")%
                </MudText>
            </MudProgressLinear>
            <div class="d-flex justify-space-between mt-n1">
                <MudTooltip Text="@GetNextPlayersTooltip(NextLowerEBPlayers, "EB")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        (@EBGoalBegin?.EBString) @(EBGoalBegin?.IGN?.Length > NameCutOff ?
                                        EBGoalBegin.IGN.Substring(0, NameCutOff) : EBGoalBegin?.IGN)
                    </MudText>
                </MudTooltip>
                <MudTooltip Text="@GetNextPlayersTooltip(NextUpperEBPlayers, "EB")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        @(EBGoalEnd?.IGN?.Length > NameCutOff ? EBGoalEnd.IGN.Substring(0, NameCutOff) :
                                        EBGoalEnd?.IGN) (@EBGoalEnd?.EBString)
                    </MudText>
                </MudTooltip>
            </div>
        </div>
        <!----------------------->
        <!-- MER Progress Bar: -->
        <!----------------------->
        <div class="mt-2 px-4" style="width: 100%;">
            <MudText Typo="Typo.subtitle2" Class="mb-0">
                MER (@PlayerStats?.MER) -- Rank: @MERGoalEnd?.Ranking
            </MudText>
            <MudProgressLinear Color="Color.Success" Value="@PlayerMERGoalPercentage" Max="100" Striped="false"
                Size="Size.Large" Style="height: 20px; border-radius: 4px;" Class="my-0">
                <MudText Typo="Typo.caption" Style="color: white;">
                    @PlayerMERGoalPercentage.ToString("F1")%
                </MudText>
            </MudProgressLinear>
            <div class="d-flex justify-space-between mt-n1">
                <MudTooltip Text="@GetNextPlayersTooltip(NextLowerMERPlayers, "MER")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        (@MERGoalBegin?.MER) @(MERGoalBegin?.IGN?.Length > NameCutOff ?
                                        MERGoalBegin.IGN.Substring(0, NameCutOff) : MERGoalBegin?.IGN)
                    </MudText>
                </MudTooltip>
                <MudTooltip Text="@GetNextPlayersTooltip(NextUpperMERPlayers, "MER")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        @(MERGoalEnd?.IGN?.Length > NameCutOff ? MERGoalEnd.IGN.Substring(0, NameCutOff) :
                                        MERGoalEnd?.IGN) (@MERGoalEnd?.MER)
                    </MudText>
                </MudTooltip>
            </div>
        </div>
        <!----------------------->
        <!-- JER Progress Bar: -->
        <!----------------------->
        <div class="mt-2 px-4" style="width: 100%;">
            <MudText Typo="Typo.subtitle2" Class="mb-0">
                JER (@PlayerStats?.JER) -- Rank: @JERGoalEnd?.Ranking
            </MudText>
            <MudProgressLinear Color="Color.Success" Value="@PlayerJERGoalPercentage" Max="100" Striped="false"
                Size="Size.Large" Style="height: 20px; border-radius: 4px;" Class="my-0">
                <MudText Typo="Typo.caption" Style="color: white;">
                    @PlayerJERGoalPercentage.ToString("F1")%
                </MudText>
            </MudProgressLinear>
            <div class="d-flex justify-space-between mt-n1">
                <MudTooltip Text="@GetNextPlayersTooltip(NextLowerJERPlayers, "JER")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        (@JERGoalBegin?.JER) @(JERGoalBegin?.IGN?.Length > NameCutOff ?
                                        JERGoalBegin.IGN.Substring(0, NameCutOff) : JERGoalBegin?.IGN)
                    </MudText>
                </MudTooltip>
                <MudTooltip Text="@GetNextPlayersTooltip(NextUpperJERPlayers, "JER")" Arrow="true" Placement="Placement.Top">
                    <MudText Typo="Typo.caption">
                        @(JERGoalEnd?.IGN?.Length > NameCutOff ? JERGoalEnd.IGN.Substring(0, NameCutOff) :
                                        JERGoalEnd?.IGN) (@JERGoalEnd?.JER)
                    </MudText>
                </MudTooltip>
            </div>
        </div>
    </MudPaper>
}
else
{
    <MudPaper Class="pa-4 d-flex justify-center">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudPaper>
}
