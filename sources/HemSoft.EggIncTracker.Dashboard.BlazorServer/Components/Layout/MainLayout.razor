@inherits LayoutComponentBase
@using System.Text.Json
@using HemSoft.EggIncTracker.Dashboard.BlazorServer.Services
@implements IDisposable

<MudThemeProvider Theme="@_theme" IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<style>
    .lap-marker {
        position: absolute;
        bottom: 0;
        transform: translateX(-50%);
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        pointer-events: none;
    }

    .lap-marker-line {
        width: 1px;
        height: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }

    .lap-marker-number {
        font-size: 7px;
        color: white;
        margin-top: -2px;
        text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.8);
        font-weight: bold;
    }

    /* Custom progress bar with gradient */
    .custom-progress-bar .mud-progress-linear-bar {
        background: linear-gradient(to right, red, yellow, green);
    }
</style>
<MudLayout>
    <MudAppBar Elevation="1"
        Style="padding: 8px; height: auto; background-image: url('/assets/banner.png'); background-size: cover; background-position: center;">
        <div
            style="background-color: rgba(@(_isDarkMode ? "26,26,39,0.7" : "255,255,255,0.7")); position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0;">
        </div>
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start"
            OnClick="@((e) => DrawerToggle())" Style="z-index: 1;" />
        <MudText Typo="Typo.h5" GutterBottom="true" Style="z-index: 1;">Egg-Inc Royal Dashboard </MudText>

        <MudSpacer />

        <!-- Event Carousel -->
        <div
            style="width: 400px; z-index: 1000; height: 100%; display: flex; align-items: center; justify-content: center;">
            <HemSoft.EggIncTracker.Dashboard.BlazorServer.Components.EventCarousel IsDarkMode="_isDarkMode" /> @* Updated namespace *@
        </div>

        <MudSpacer />

        <MudPaper Class="d-flex align-center py-2 px-4 rounded-xl mr-5"
            Style="background-color: rgba(128,128,128,0.1); border: 1px solid rgba(180,180,180,0.3); margin-bottom: 4px; margin-top: 4px; z-index: 1;">
            <MudStack Spacing="0" Class="mr-4">
                <MudButton Variant="Variant.Filled" Color="@(_isRunning? Color.Error: Color.Success)" Size="Size.Small"
                    Style="height: 24px; min-height: 24px;" OnClick="ToggleStopwatch">
                    @(_isRunning ? "Stop" : "Start")
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                    Style="height: 24px; min-height: 24px; margin-top: 4px;" OnClick="ResetStopwatch">
                    Reset
                </MudButton>
            </MudStack>
            <MudStack Style="min-width: 160px;" Spacing="0">
                <div class="d-flex justify-center mb-1">
                    <MudText Typo="Typo.h6" Style="font-family: monospace; line-height: 1;" Class="mb-1">
                        @* Removed loading indicator related to localStorage *@
                        @GetFormattedTime()
                    </MudText>
                </div>
                <div @onclick="ResetMinuteProgress"
                    style="cursor: pointer; height: 10px; margin-top: 3px; position: relative;">
                    <MudProgressLinear Value="@GetProgressValue(0, 60, _minuteStartTime)"
                        Striped="@(GetProgressValue(0, 60, _minuteStartTime) >= 100)" Style="height: 10px;"
                        Color="@(GetProgressValue(0, 60, _minuteStartTime) >= 100 ? Color.Success : Color.Primary)"
                        Class="custom-progress-bar" />
                </div>
                <div @onclick="IncrementLegs"
                    style="cursor: pointer; height: 10px; margin-top: 5px; position: relative;">
                    <MudProgressLinear Value="@GetProgressValue(0, 1510, _25minStartTime)"
                        Striped="@(GetProgressValue(0, 1510, _25minStartTime) >= 100)" Style="height: 10px;"
                        Color="@(GetProgressValue(0, 1510, _25minStartTime) >= 100 ? Color.Success : Color.Primary)"
                        Class="custom-progress-bar" />
                    @foreach (var marker in _lapMarkers)
                    {
                        <div class="lap-marker" style="left: @(marker)%">
                            <div class="lap-marker-line"></div>
                            <div class="lap-marker-number">@(_lapMarkers.IndexOf(marker) + 1)</div>
                        </div>
                    }
                </div>
            </MudStack>
            <MudButton Class="ml-3" Style="height: 100%; min-width: 50px;" Variant="Variant.Outlined"
                OnClick="IncrementLegs" Color="Color.Primary">
                <MudStack Spacing="0" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.caption">Legs</MudText>
                    <MudText Typo="Typo.h5" Style="font-family: monospace;">@_legCount</MudText>
                </MudStack>
            </MudButton>
        </MudPaper>

        <!-- Current Time -->
        <MudText Typo="Typo.h2" Class="mr-4" Style="z-index: 1;">
            @(_currentTime.ToString("HH:mm"))
        </MudText>
        <MudIconButton Icon="@(DarkLightModeButtonIcon)" Color="Color.Inherit" OnClick="@DarkModeToggle"
            Style="z-index: 1;" />
        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" Color="Color.Inherit" Edge="Edge.End"
            Style="z-index: 1;" />
    </MudAppBar>
    <MudDrawer id="nav-drawer" @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2"
        Style="padding-top: 32px;">
        <NavMenu />
    </MudDrawer>
    <MudMainContent Class="mt-16 pa-4">
        @Body
    </MudMainContent>
</MudLayout>

@* Removed Blazor WASM error UI *@
@* <div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div> *@


